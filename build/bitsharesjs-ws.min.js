(function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,b.bitshares_ws=a()}})(function(){return function(){function b(d,e,g){function a(j,i){if(!e[j]){if(!d[j]){var f="function"==typeof require&&require;if(!i&&f)return f(j,!0);if(h)return h(j,!0);var c=new Error("Cannot find module '"+j+"'");throw c.code="MODULE_NOT_FOUND",c}var k=e[j]={exports:{}};d[j][0].call(k.exports,function(b){var c=d[j][1][b];return a(c||b)},k,k.exports,b,d,e,g)}return e[j].exports}for(var h="function"==typeof require&&require,c=0;c<g.length;c++)a(g[c]);return a}return b}()({1:[function(a,b,c){"use strict";function d(b){return b&&b.__esModule?b:{default:b}}Object.defineProperty(c,"__esModule",{value:!0}),c.setRpcConnectionStatusCallback=c.setAutoReconnect=c.reset=c.orders=c.network=c.instance=c.history=c.db=c.crypto=c.close=c.chainId=void 0;var e=d(a("./ChainWebSocket")),f=d(a("./GrapheneApi")),g=d(a("./ChainConfig")),h=!1,i=null,j=null;const k=b=>{j=b,i&&i.setRpcConnectionStatusCallback(b)};c.setRpcConnectionStatusCallback=k;c.setAutoReconnect=b=>{h=b};c.reset=function(){let f=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",a=1<arguments.length?arguments[1]:void 0,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3,c=3<arguments.length?arguments[3]:void 0,d=4<arguments.length?arguments[4]:void 0;return m().then(()=>(i=t(),i.setRpcConnectionStatusCallback(j),i&&a&&i.connect(f,b,c,d),i))};const l=function(){let f=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",a=1<arguments.length?arguments[1]:void 0,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3,c=3<arguments.length?arguments[3]:void 0,d=4<arguments.length?arguments[4]:void 0;return i||(i=t(),i.setRpcConnectionStatusCallback(j)),i&&a&&i.connect(f,b,c),d&&(i.closeCb=d),i};c.instance=l;c.chainId=()=>l().chain_id;const m=async()=>{i&&(await i.close(),i=null)};c.close=m;const n=f=>new Proxy([],{get:(a,g)=>function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return i[f].exec(g,[...b])}}),o=n("_db");c.db=o;const p=n("_net");c.network=p;const q=n("_hist");c.history=q;const r=n("_crypt");c.crypto=r;const s=n("_orders");c.orders=s;const t=()=>({connect:function(d,a){let j=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{enableCrypto:!1,enableOrders:!1};if(i.url=d,"undefined"!=typeof window&&window.location&&"https:"===window.location.protocol&&0>d.indexOf("wss://"))throw new Error("Secure domains require wss connection");i.ws_rpc&&(i.ws_rpc.statusCb=null,i.ws_rpc.keepAliveCb=null,i.ws_rpc.on_close=null,i.ws_rpc.on_reconnect=null),i.ws_rpc=new e.default(d,i.statusCb,a,h,b=>{i._db&&!b&&i._db.exec("get_objects",[["2.1.0"]]).catch(()=>{})}),i.init_promise=i.ws_rpc.login("","").then(()=>{i._db=new f.default(i.ws_rpc,"database"),i._net=new f.default(i.ws_rpc,"network_broadcast"),i._hist=new f.default(i.ws_rpc,"history"),j.enableOrders&&(i._orders=new f.default(i.ws_rpc,"orders")),j.enableCrypto&&(i._crypt=new f.default(i.ws_rpc,"crypto"));var c=i._db.init().then(()=>i._db.exec("get_chain_id",[]).then(b=>(i.chain_id=b,g.default.setChainId(b))));i.ws_rpc.on_reconnect=()=>{i.ws_rpc&&i.ws_rpc.login("","").then(()=>{i._db.init().then(()=>{i.statusCb&&i.statusCb("reconnect")}),i._net.init(),i._hist.init(),j.enableOrders&&i._orders.init(),j.enableCrypto&&i._crypt.init()})},i.ws_rpc.on_close=()=>{i.close().then(()=>{i.closeCb&&i.closeCb()})};let a=[c,i._net.init(),i._hist.init()];return j.enableOrders&&a.push(i._orders.init()),j.enableCrypto&&a.push(i._crypt.init()),Promise.all(a)}).catch(a=>(console.error(d,"Failed to initialize with error",a&&a.message),i.close().then(()=>{throw a})))},close:async()=>{i.ws_rpc&&1===i.ws_rpc.ws.readyState&&(await i.ws_rpc.close()),i.ws_rpc=null},db_api:()=>i._db,network_api:()=>i._net,history_api:()=>i._hist,crypto_api:()=>i._crypt,orders_api:()=>i._orders,setRpcConnectionStatusCallback:b=>i.statusCb=b})},{"./ChainConfig":2,"./ChainWebSocket":3,"./GrapheneApi":5}],2:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var e={core_asset:"CORE",address_prefix:"GPH",expire_in_secs:15,expire_in_secs_proposal:86400,review_in_secs_committee:86400,networks:{BitShares:{core_asset:"BTS",address_prefix:"BTS",chain_id:"4018d7844c78f6a6c41c6a552b898022310fc5dec06da467ee7905a8dad512c8"},Muse:{core_asset:"MUSE",address_prefix:"MUSE",chain_id:"45ad2d3f9ef92a49b55c2227eb06123f613bb35dd08bd876f2aea21925a67a67"},Test:{core_asset:"TEST",address_prefix:"TEST",chain_id:"39f5e2ede1f8bc1a3a54a7914414e3779e33193f1f5693510e73cb7a87617447"},Obelisk:{core_asset:"GOV",address_prefix:"FEW",chain_id:"1cfde7c388b9e8ac06462d68aadbd966b58f88797637d9af805b4560b0e9661e"}},setChainId:f=>{let a=Object.entries(e.networks).find(a=>{let[b,c]=a;if(c.chain_id===f)return e.network_name=b,c.address_prefix&&(e.address_prefix=c.address_prefix),!0});return a?{network_name:a[0],network:a[1]}:void console.log("Unknown chain id (this may be a testnet)",f)},reset:()=>{e.core_asset="CORE",e.address_prefix="GPH",e.expire_in_secs=15,e.expire_in_secs_proposal=86400,console.log("Chain config reset")},setPrefix:function(){let b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"GPH";return e.address_prefix=b}};c.default=e},{}],3:[function(a,b,c){"use strict";function f(d,a,b){return a in d?Object.defineProperty(d,a,{value:b,enumerable:!0,configurable:!0,writable:!0}):d[a]=b,d}var g=function(b){return b&&b.__esModule?b:{default:b}}(a("isomorphic-ws"));Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;const h=!1,i=5,j=10;c.default=class{constructor(k,a){let b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:5e3,c=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],d=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;f(this,"connect",(c,a)=>new Promise((b,e)=>{this.current_reject=e,this.current_resolve=b;try{this.ws=new g.default(c)}catch(a){this.ws={readyState:3,close:()=>{}},e(new Error("Invalid url",c," closed"))}this.ws.onopen=this.onOpen,this.ws.onerror=this.onError,this.ws.onmessage=this.onMessage,this.ws.onclose=this.onClose,this.connectionTimeout=setTimeout(()=>{this.current_reject&&(this.current_reject=null,this.close(),e(new Error("Connection attempt timed out after "+a/1e3+"s")))},a)})),f(this,"onOpen",()=>{clearTimeout(this.connectionTimeout),this.statusCb&&this.statusCb("open"),this.on_reconnect&&this.on_reconnect(),this.keepalive_timer=setInterval(()=>(this.recv_life--,0==this.recv_life?(console.error(this.url+" connection is dead, terminating ws"),void this.close()):void(this.send_life--,0==this.send_life&&(this.keepAliveCb&&this.keepAliveCb(this.closed),this.send_life=i))),5e3),this.current_reject=null,this.current_resolve()}),f(this,"onError",b=>{this.keepalive_timer&&(clearInterval(this.keepalive_timer),this.keepalive_timer=void 0),clearTimeout(this.connectionTimeout),this.statusCb&&this.statusCb("error"),this.current_reject&&this.current_reject(b)}),f(this,"onMessage",b=>{this.recv_life=j,this.listener(JSON.parse(b.data))}),f(this,"onClose",()=>{this.closed=!0,this.keepalive_timer&&(clearInterval(this.keepalive_timer),this.keepalive_timer=void 0);for(var b=this.responseCbId+1;b<=this.cbId;b+=1)this.cbs[b].reject(new Error("connection closed"));this.statusCb&&this.statusCb("closed"),this._closeCb&&this._closeCb(),this.on_close&&this.on_close()}),f(this,"call",d=>{if(1!==this.ws.readyState)return Promise.reject(new Error("websocket state error:"+this.ws.readyState));let a=d[1];if(h&&console.log("[ChainWebSocket] >---- call ----->  \"id\":"+(this.cbId+1),JSON.stringify(d)),this.cbId+=1,["set_subscribe_callback","subscribe_to_market","broadcast_transaction_with_callback","set_pending_transaction_callback","set_block_applied_callback"].includes(a)&&(this.subs[this.cbId]={callback:d[2][0]},d[2][0]=this.cbId),["unsubscribe_from_market","unsubscribe_from_accounts"].includes(a)){if("function"!=typeof d[2][0])throw new Error("First parameter of unsub must be the original callback");let c=d[2].splice(0,1)[0];for(let b in this.subs)if(this.subs[b].callback===c){this.unsub[this.cbId]=b;break}}var e={method:"call",params:d};return e.id=this.cbId,this.send_life=i,new Promise((c,a)=>{this.cbs[this.cbId]={time:new Date,resolve:c,reject:a},this.ws.send(JSON.stringify(e))})}),f(this,"listener",d=>{h&&console.log("[ChainWebSocket] <---- reply ----<",JSON.stringify(d));let a=!1,e=null;"notice"===d.method&&(a=!0,d.id=d.params[0]),a?e=this.subs[d.id].callback:(e=this.cbs[d.id],this.responseCbId=d.id),e&&!a?(d.error?e.reject(d.error):e.resolve(d.result),delete this.cbs[d.id],this.unsub[d.id]&&(delete this.subs[this.unsub[d.id]],delete this.unsub[d.id])):e&&a?e(d.params[1]):console.log("Warning: unknown websocket response: ",d)}),f(this,"login",(c,a)=>this.connect_promise.then(()=>this.call([1,"login",[c,a]]))),f(this,"close",()=>new Promise(b=>(clearInterval(this.keepalive_timer),this.keepalive_timer=void 0,this._closeCb=()=>{b(),this._closeCb=null},this.ws?void(this.ws.terminate?this.ws.terminate():this.ws.close(),3===this.ws.readyState&&b()):(console.log("Websocket already cleared",this),b())))),this.url=k,this.statusCb=a,this.current_reject=null,this.on_reconnect=null,this.closed=!1,this.send_life=i,this.recv_life=j,this.keepAliveCb=d,this.cbId=0,this.responseCbId=0,this.cbs={},this.subs={},this.unsub={},this.connect_promise=this.connect(k,b)}}},{"isomorphic-ws":7}],4:[function(a,b,c){"use strict";function h(d){if("function"!=typeof WeakMap)return null;var e=new WeakMap,b=new WeakMap;return(h=function(c){return c?b:e})(d)}function i(i,a){if(!a&&i&&i.__esModule)return i;if(null===i||"object"!=typeof i&&"function"!=typeof i)return{default:i};var b=h(a);if(b&&b.has(i))return b.get(i);var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in i)if("default"!=e&&Object.prototype.hasOwnProperty.call(i,e)){var f=d?Object.getOwnPropertyDescriptor(i,e):null;f&&(f.get||f.set)?Object.defineProperty(c,e,f):c[e]=i[e]}return c.default=i,b&&b.set(i,c),c}function j(d,a,b){return a in d?Object.defineProperty(d,a,{value:b,enumerable:!0,configurable:!0,writable:!0}):d[a]=b,d}Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var k=i(a("./ApiInstances")),l=function(b){return b&&b.__esModule?b:{default:b}}(a("./ChainWebSocket"));c.default=class{constructor(i){var m=this;let{url:a,urls:b,autoFallback:c,closeCb:d,optionalApis:e,urlChangeCallback:f}=i;j(this,"setCloseCb",b=>{this.closeCb=b}),j(this,"logFailure",(e,a,b)=>{let c=b&&b.message?b.message:"";console.error(e,"Failed to connect to "+a+(c?" Error: "+JSON.stringify(c):""))}),j(this,"_onClose",()=>{this.isConnected=!1,this.closeCb&&(this.closeCb(),this.setCloseCb(null)),this.autoFallback&&this.connectWithFallback()}),j(this,"connect",async function(){let b=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:m.url;try{let c=await k.instance(a,b,void 0,m.optionalApis,m._onClose).init_promise;return m.url=a,m.isConnected=!0,c}catch(b){throw await k.close(),b}}),j(this,"connectWithFallback",async function(){let b=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:m.url,g=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,e=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;if(g>m.urls.length)return e(new Error("Tried "+g+" connections, none of which worked: "+JSON.stringify(m.urls.concat(m.url))));try{return await m.connect(b,a)}catch(a){return m.urlChangeCallback&&m.urlChangeCallback(m.urls[g]),m.connectWithFallback(b,m.urls[g],g+1,d,e)}}),j(this,"checkConnections",async function(){let i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",b=2<arguments.length?arguments[2]:void 0,c=3<arguments.length?arguments[3]:void 0,j={},d=m.urls.concat(m.url),e=d.map(async c=>{let d=new l.default(c,()=>{},void 0,!1);j[c]=new Date().getTime();try{await d.login(i,a);let e={[c]:new Date().getTime()-j[c]};return await d.close(),e}catch(b){return c===m.url?m.url=m.urls[0]:m.urls=m.urls.filter(a=>a!==c),void(await d.close())}});try{let c=await Promise.all(e),a=c.filter(a=>!!a).sort((b,c)=>Object.values(b)[0]-Object.values(c)[0]).reduce((d,b)=>{let c=Object.keys(b)[0];return d[c]=b[c],d},{});return console.log(`Checked ${c.length} connections, ${c.length-Object.keys(a).length} failed`),a}catch(d){return m.checkConnections(i,a,b,c)}}),this.url=a,this.urls=b.filter(c=>c!==a),this.autoFallback=c,this.closeCb=d,this.optionalApis=e||{},this.isConnected=!1,this.urlChangeCallback=f}static close(){return k.close()}}},{"./ApiInstances":1,"./ChainWebSocket":3}],5:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;c.default=class{constructor(c,a){this.ws_rpc=c,this.api_name=a}init(){var c=this;return this.ws_rpc.call([1,this.api_name,[]]).then(a=>(c.api_id=a,c))}exec(c,a){return this.ws_rpc.call([this.api_id,c,a]).catch(b=>{throw b})}}},{}],6:[function(a,b,c){"use strict";function d(b){return b&&b.__esModule?b:{default:b}}function h(d){if("function"!=typeof WeakMap)return null;var e=new WeakMap,b=new WeakMap;return(h=function(c){return c?b:e})(d)}function i(i,a){if(!a&&i&&i.__esModule)return i;if(null===i||"object"!=typeof i&&"function"!=typeof i)return{default:i};var b=h(a);if(b&&b.has(i))return b.get(i);var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in i)if("default"!=e&&Object.prototype.hasOwnProperty.call(i,e)){var f=d?Object.getOwnPropertyDescriptor(i,e):null;f&&(f.get||f.set)?Object.defineProperty(c,e,f):c[e]=i[e]}return c.default=i,b&&b.set(i,c),c}var j=i(a("./ApiInstances"));Object.defineProperty(c,"__esModule",{value:!0}),c.Apis=void 0,Object.defineProperty(c,"ChainConfig",{enumerable:!0,get:function(){return l.default}}),Object.defineProperty(c,"Manager",{enumerable:!0,get:function(){return k.default}}),c.Apis=j;var k=d(a("./ConnectionManager")),l=d(a("./ChainConfig"))},{"./ApiInstances":1,"./ChainConfig":2,"./ConnectionManager":4}],7:[function(a,b){(function(a){(function(){var c=null;"undefined"==typeof WebSocket?"undefined"==typeof MozWebSocket?"undefined"==typeof a?"undefined"==typeof window?"undefined"!=typeof self&&(c=self.WebSocket||self.MozWebSocket):c=window.WebSocket||window.MozWebSocket:c=a.WebSocket||a.MozWebSocket:c=MozWebSocket:c=WebSocket,b.exports=c}).call(this)}).call(this,"undefined"==typeof global?"undefined"==typeof self?"undefined"==typeof window?{}:window:self:global)},{}]},{},[6])(6)});